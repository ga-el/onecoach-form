---
// Form configuration
const formConfig = {
  title: "MULTIPLE EMPRESARIAL",
  logo: "/images/logo-one-coach.png",
  theme: {
    primary: "#002366", // Royal blue
    secondary: "#ffffff", // White
    accent: "#e74c3c",
    background: "#f8f9fa",
    text: "#2c3e50"
  }
};

// Set default date to today
const today = new Date();
const formattedDate = today.toLocaleDateString('es-MX', {
  year: 'numeric',
  month: '2-digit',
  day: '2-digit'
}).replace(/\//g, '-');
---

<div class="wpforms-container">
  <form id="multiple-empresarial-form" class="wpforms-form">
    <!-- Header -->
    <div class="wpforms-head-container">
      <div class="wpforms-title">{formConfig.title}</div>
    </div>

    <!-- Agent and Date -->
    <div class="wpforms-field-container">
      <div class="wpforms-field">
        <div class="form-row">
          <div class="form-group">
            <label for="nombre-agente">NOMBRE DEL AGENTE</label>
            <input type="text" id="nombre-agente" name="nombre_agente" required>
          </div>
          <div class="form-group">
            <label for="fecha">FECHA</label>
            <input type="date" id="fecha" name="fecha" value={formattedDate}>
          </div>
        </div>
      </div>

      <!-- Clave Section -->
      <div class="wpforms-field">
        <div class="form-row">
          <div class="form-group">
            <fieldset>
              <legend>Casillas de verificación</legend>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" name="clave[]" value="CLAVE ONE COACH">
                  <span>CLAVE ONE COACH</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="clave[]" value="CLAVE AGENTE">
                  <span>CLAVE AGENTE</span>
                </label>
              </div>
            </fieldset>
          </div>
          <div class="form-group">
            <label for="clave-numero">CLAVE :</label>
            <input type="text" id="clave-numero" name="clave_numero">
          </div>
        </div>
      </div>

      <!-- Cotización Section -->
      <div class="section-divider">
        <div class="form-row">
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" name="cotizacion" value="COTIZACIÓN" required>
              <span>COTIZACIÓN</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Moneda y Vigencia -->
      <div class="section-divider">
        <div class="form-row">
          <div class="form-group">
            <h3>MONEDA:</h3>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="moneda" value="NACIONAL" required>
                <span>NACIONAL</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="moneda" value="DÓLARES" required>
                <span>DÓLARES</span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <h3>VIGENCIA:</h3>
            <div class="date-range">
              <div class="form-group">
                <label for="fecha-desde">DESDE:</label>
                <input type="date" id="fecha-desde" name="fecha_desde" required>
              </div>
              <div class="form-group">
                <label for="fecha-hasta">HASTA:</label>
                <input type="date" id="fecha-hasta" name="fecha_hasta" required>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Forma de Pago -->
      <div class="section-divider">
        <h3>FORMA DE PAGO:</h3>
        <div class="form-row">
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" name="pago[]" value="ANUAL">
              <span>ANUAL</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="pago[]" value="SEMESTRAL">
              <span>SEMESTRAL</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="pago[]" value="TRIMESTRAL">
              <span>TRIMESTRAL</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="pago[]" value="MENSUAL">
              <span>MENSUAL</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="form-actions">
      <button type="submit" class="submit-button" id="submit-btn">Enviar</button>
    </div>
  </form>
</div>

<!-- Notification Container -->
<div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<style>
  /* Base Styles */
  .wpforms-container {
    max-width: 1000px;
    margin: 2rem auto;
    font-family: Arial, sans-serif;
  }

  .wpforms-form {
    background: white;
    padding: 2rem;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  }

  .wpforms-head-container {
    background: var(--primary, #002366);
    color: white;
    padding: 1rem 2rem;
    margin: -2rem -2rem 2rem -2rem;
  }

  .wpforms-title {
    font-size: 1.5rem;
    font-weight: bold;
    text-transform: uppercase;
  }

  /* Form Elements */
  .form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .form-group {
    flex: 1;
    min-width: 200px;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    font-size: 0.9rem;
    color: #333;
  }

  input[type="text"],
  input[type="date"],
  input[type="email"],
  input[type="tel"],
  select,
  textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
  }

  /* Checkbox and Radio Buttons */
  .checkbox-group,
  .radio-group {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 0.5rem;
  }

  .checkbox-label,
  .radio-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: normal;
    cursor: pointer;
  }

  /* Section Dividers */
  .section-divider {
    padding: 1.5rem 0;
    border-bottom: 1px solid #eee;
    margin-bottom: 1.5rem;
  }

  .section-divider h3 {
    color: var(--primary, #002366);
    margin-bottom: 1rem;
    font-size: 1.1rem;
  }

  /* Buttons */
  .form-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 2rem;
  }

  .submit-button {
    background: var(--primary, #002366);
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .submit-button:hover {
    background: #001a4d;
  }

  .submit-button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  /* Notification Styles */
  .notification {
    padding: 1.5rem 2rem;
    border-radius: 12px;
    margin-bottom: 1rem;
    color: white;
    font-weight: 600;
    min-width: 350px;
    max-width: 500px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    transform: translateX(400px);
    transition: all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
    border-left: 5px solid rgba(255, 255, 255, 0.3);
    font-size: 14px;
    line-height: 1.5;
  }

  .notification.show {
    transform: translateX(0);
  }

  .notification-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-left-color: #34d399;
  }

  .notification-error {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border-left-color: #f87171;
  }

  .notification-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border-left-color: #fbbf24;
  }

  .notification-info {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    border-left-color: #60a5fa;
  }

  .notification-icon {
    display: inline-block;
    margin-right: 10px;
    font-size: 18px;
  }

  .notification-title {
    font-weight: 700;
    margin-bottom: 5px;
    font-size: 16px;
  }

  .notification-message {
    opacity: 0.95;
    font-weight: 500;
  }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .form-row {
      flex-direction: column;
      gap: 1rem;
    }
    
    .form-group {
      width: 100%;
    }
    
    .wpforms-container {
      padding: 0 1rem;
    }
  }
</style>

<script>
  // EmailJS Configuration
  const EMAILJS_CONFIG = {
    PUBLIC_KEY: '9uhWKUO7vI9o1xXgK',
    SERVICE_ID: 'service_6gnqp8y', // Service ID real
    TEMPLATE_ID: 'template_2yre1uf' // Template ID real
  };

  // Notification System
  function showNotification(message: string, type = 'info', duration = 6000) {
    const container = document.getElementById('notification-container');
    if (!container) {
      console.error('❌ No se encontró el contenedor de notificaciones');
      return;
    }
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    
    // Icons for different notification types
    const icons: Record<string, string> = {
      success: '✅',
      error: '❌',
      warning: '⚠️',
      info: 'ℹ️'
    };
    
    // Create notification content with icon and better structure
    notification.innerHTML = `
      <div class="notification-icon">${icons[type] || icons.info}</div>
      <div class="notification-content">
        <div class="notification-title">${getNotificationTitle(type)}</div>
        <div class="notification-message">${message}</div>
      </div>
    `;
    
    container.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
      notification.classList.add('show');
    }, 10);
    
    // Auto remove
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 400);
    }, duration);
  }

  // Helper function to get notification titles
  function getNotificationTitle(type: string): string {
    const titles: Record<string, string> = {
      success: '¡Éxito!',
      error: 'Error',
      warning: 'Advertencia',
      info: 'Información'
    };
    return titles[type] || titles.info;
  }

  // Load EmailJS SDK
  function loadEmailJSSDK() {
    return new Promise((resolve, reject) => {
      // Check if already loaded
      if ((window as any).emailjs) {
        resolve((window as any).emailjs);
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
      script.async = true;
      
      script.onload = () => {
        try {
          (window as any).emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
          console.log('✅ EmailJS inicializado correctamente');
          resolve((window as any).emailjs);
        } catch (error) {
          console.error('❌ Error al inicializar EmailJS:', error);
          reject(error);
        }
      };
      
      script.onerror = () => {
        reject(new Error('No se pudo cargar EmailJS SDK'));
      };
      
      document.head.appendChild(script);
    });
  }

  // Form submission handler
  async function handleFormSubmit(event: Event) {
    event.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    if (!submitBtn) {
      console.error('❌ No se encontró el botón de envío');
      return;
    }
    
    const originalText = submitBtn.textContent;
    
    try {
      // Show loading state
      submitBtn.textContent = 'Enviando...';
      submitBtn.disabled = true;
      
      // Load EmailJS if not already loaded
      await loadEmailJSSDK();
      
      // Validate required fields
      const form = event.target as HTMLFormElement;
      const formData = new FormData(form);
      
      // Check required fields
      const requiredFields = ['nombre_agente', 'cotizacion', 'moneda', 'fecha_desde', 'fecha_hasta'];
      const missingFields = [];
      
      requiredFields.forEach(field => {
        const value = formData.get(field);
        if (!value || (Array.isArray(value) && value.length === 0)) {
          missingFields.push(field);
        }
      });
      
      if (missingFields.length > 0) {
        showNotification('❌ Por favor completa todos los campos requeridos', 'error');
        return;
      }
      
      // Prepare email parameters
      const params = {
        // Agent and Date
        nombre_agente: formData.get('nombre_agente'),
        fecha: formData.get('fecha'),
        
        // Clave
        clave_one_coach: formData.getAll('clave[]').includes('CLAVE ONE COACH') ? 'Sí' : 'No',
        clave_agente: formData.getAll('clave[]').includes('CLAVE AGENTE') ? 'Sí' : 'No',
        clave_numero: formData.get('clave_numero'),
        
        // Cotización
        cotizacion: formData.get('cotizacion'),
        
        // Moneda y Vigencia
        moneda: formData.get('moneda'),
        fecha_desde: formData.get('fecha_desde'),
        fecha_hasta: formData.get('fecha_hasta'),
        
        // Forma de Pago
        pago_anual: formData.getAll('pago[]').includes('ANUAL') ? 'Sí' : 'No',
        pago_semestral: formData.getAll('pago[]').includes('SEMESTRAL') ? 'Sí' : 'No',
        pago_trimestral: formData.getAll('pago[]').includes('TRIMESTRAL') ? 'Sí' : 'No',
        pago_mensual: formData.getAll('pago[]').includes('MENSUAL') ? 'Sí' : 'No',
        
        // Additional info
        form_type: 'MULTIPLE EMPRESARIAL',
        submission_date: new Date().toLocaleString('es-MX'),
        year: new Date().getFullYear()
      };
      
      console.log('📨 Enviando formulario con EmailJS...', params);
      
      // Send email
      const result = await (window as any).emailjs.send(
        EMAILJS_CONFIG.SERVICE_ID,
        EMAILJS_CONFIG.TEMPLATE_ID,
        params
      );
      
      console.log('✅ EmailJS resultado:', result);
      
      // Success
      showNotification(
        '¡Formulario enviado exitosamente! Se ha enviado una copia a gael.madrid.2009@gmail.com. Revisa tu correo (incluyendo spam) para confirmar la recepción.',
        'success'
      );
      submitBtn.textContent = '✅ Enviado Exitosamente';
      submitBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
      
      // Reset form after 3 seconds
      setTimeout(() => {
        form.reset();
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.background = '';
      }, 3000);
      
    } catch (error) {
      console.error('❌ Error al enviar formulario:', error);
      
      let errorMessage = 'No se pudo enviar el formulario';
      
      if (error && typeof error === 'object') {
        if ('text' in error) {
          errorMessage = String(error.text);
        } else if ('message' in error) {
          errorMessage = String(error.message);
        }
      }
      
      showNotification(
        `No se pudo enviar el formulario. Error: ${errorMessage}. Por favor, verifica tu conexión a internet e intenta nuevamente. Si el problema persiste, contacta al soporte técnico.`,
        'error'
      );
      
      // Reset button
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  }

  // Set default dates
  document.addEventListener('DOMContentLoaded', function() {
    // Set default end date to 1 year from now
    const startDateInput = document.getElementById('fecha-desde');
    const endDateInput = document.getElementById('fecha-hasta');
    
    if (startDateInput && !startDateInput.value) {
      const today = new Date();
      startDateInput.valueAsDate = today;
      
      const oneYearLater = new Date(today);
      oneYearLater.setFullYear(today.getFullYear() + 1);
      endDateInput.valueAsDate = oneYearLater;
    }
    
    // Form submission
    const form = document.getElementById('multiple-empresarial-form');
    if (form) {
      form.addEventListener('submit', handleFormSubmit);
    }
    
    // Preload EmailJS SDK
    loadEmailJSSDK().catch(error => {
      console.warn('⚠️ EmailJS no se pudo cargar previamente:', error);
    });
  });
</script>
